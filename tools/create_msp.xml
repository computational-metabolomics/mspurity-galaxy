<tool id="create_msp" name="Create MSP" version="0.2.0">
    <description>files from msPurity</description>
     <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
    </expand>


    <command interpreter="Rscript" ><![CDATA[
	  create_msp.R
	  --rdata_input "$rdata_input"
    --method "$method"
    
    #if $metadata_cond.metadata_select == "true"
	    --metadata "$metadata"
	    --metadata_cols "$metadata_cols"
	    --adduct_split "$adduct_split"
	  #end if
	  
	  #if $xcms_group_cond.xcms_group_select == "true"
	    --xcms_groupids "$xcms_groupids"
	  #end if
	  
    ]]></command>
    <inputs>
        <param name="rdata_input" type="data" format="rdata" label="msPurity purityA dataset" argument="--purity_dataset"
        help="RData file containing the purityA object following frag4feature and/or averageFragmentation"/>
        <param name="method" type="select" label="Spectra use mode (if precursor was fragmented in >1 scans)" 
        help="'Average all' will use the averaged MS/MS spectra of the XCMS grouped feature, ignoring inter and intra file relationships,
             'Average' (intra)' will use the intra file (within file) averaged MS/MS spectra of the XCMS grouped feature,
             'Average (inter)' will use the inter file (across file) MS/MS averaged spectra,
             'All scans' will export all matching MS/MS spectra to XCMS grouped features,  
             'Max intensity' will choose the most MS/MS spectra with the most intense precursor ion for each XCMS grouped feature"  
             argument="--method">
            <option value="av_all" selected="true" >Average (all)</option>
            <option value="av_intra">Average (intra)</option>
            <option value="av_inter">Average (inter)</option>
            <option value="all_scans">All scans</option>
            <option value="max" >Max intensity</option>
        </param>
     
        <conditional name="metadata_cond">
          <param name="metadata_select" type="boolean" label="Use additional metadata?" />
            
	          <when value="true">
                <param type="data" name="metadata" label="Metadata for each feature" format="tsv,tabular"
                    help="Metadata for each grouped XCMS feature, the data will be added to the MSP metadata.
                    Using the MassBank format e.g. https://github.com/MassBank/MassBank-data/blob/master/MetaboLights/ML003001.txt "/>
                <param name="metadata_cols" type="text" label="Metadata columns for name" value="CH$NAME, MS$FOCUSED_ION: PRECURSOR_TYPE"
                    help="Comma separated string of column names where the corresponding values in the metadata will be used for the MSP spectra name"/>          
                <param name="adduct_split" type="boolean" checked="true" label="Create MSP spectra for each adduct?"
                    help="If either 'adduct' or  'MS$FOCUSED_ION: PRECURSOR_TYPE' 
                            column is in metadata then each adduct will have it's own MSP spectra. 
                            (Useful, if the MSP file will be used for further annotation)"  />
            </when>
            <when value="false">
            </when>
        </conditional>
        
        <conditional name="xcms_group_cond">
          <param name="xcms_group_select" type="boolean" label="Select XCMS groups?" help="if set to no, all XCMS group features will be used" />
            <when value="true">
              <param name="xcms_groupids" type="text" label="XCMS peak group ids" value=""
                help="Comma separated string of XCMS group ids to export MSP spectra for. If blank all XCMS peak groups will be used"/>
            </when>
            <when value="false">
            </when>
        </conditional>
  
    </inputs>
    <outputs>
        <data name="output" format="txt" label="log" />
        <data name="msp_out" format="msp" from_work_dir="outfile.msp" label="${rdata_input.name} MSP file"/>
    </outputs>
    <tests>
        <test>
            <param name="mode" value="all"/>
            <param name="purity" value="lightpurity.RData"/>
            <output name="msp_out" file="input.msp"/>
        </test>
      
    </tests>
	<help><![CDATA[
------------------------------
Create MSP Files from msPurity
------------------------------

Description
-----------

| This tool will extract the MSMS spectra data from an msPurity-frag4feature object into a file with MSP data format.



		
Developers and contributors
---------------------------

- **Jordi Capellades (j.capellades.to@gmail.com) - Universitat Rovira i Virgili (SP)**
- **Andris Jankevics () - University of Birmingham (UK)**
- **Thomas N. Lawson (t.n.lawson@bham.ac.uk) - University of Birmingham (UK)**
- **Ralf Weber (r.j.weber@bham.ac.uk) - University of Birmingham (UK)**

	]]></help>

<expand macro="citations" />
  
</tool>
