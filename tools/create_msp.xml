<tool id="create_msp" name="Create MSP Files from msPurity" version="0.2.0">
    <description> </description>
     <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
    </expand>


    <command interpreter="Rscript" ><![CDATA[
	create_msp.R
	--purity "$purity"
	--mode "$mode"
	--ppm "$ppm"
    ]]></command>
    <inputs>
        <param name="purity" type="data" format="rdata" label="msPurity purityA dataset" argument="--purity_dataset"
        help="RData file containing the purityA object following frag4feature and/or averageFragmentation"/>
        <param name="mode" type="select" label="Spectra use mode (if precursor was fragmented in >1 scans)" 
        help='"All scans" will export all matching ms/ms spectra to xcms features,
               "Average (intra)" will use the intra file averaged spectra (within file), "Average (inter)" will use the inter file (across file)
                averaged spectra, "av-all" will use the averaged spectra (ignoring inter and intra)' argument="--method">
            <option value="av_all" selected="true" >Average (all)</option>
            <option value="av_intra">Average (intra)</option>
            <option value="av_inter">Average (inter)</option>
            <option value="all_scans">All scans</option>
            <option value="max" >Max Intensity</option>
        </param>
        <param name="adduct_split" type="boolean" checked="true" label="Create MSP spectra for each adduct?"
             help="If either 'adduct' or  'MS$FOCUSED_ION: PRECURSOR_TYPE'
              column is in metadata then each adduct will have it's own MSP spectra.
              (Useful, if the MSP file will be used for further annotation)"  />
        <param type="data" name="metadata" label="Metadata for each feature" format="tsv,tabular"
                               help="Metadata for each grouped XCMS feature, the data will be added to the MSP metadata.
                                     Using the MassBank format e.g. https://github.com/MassBank/MassBank-data/blob/master/MetaboLights/ML003001.txt "/>
        <param name="metadata_cols" type="text" label="Metadata columns for name" value="CH$NAME, MS$FOCUSED_ION: PRECURSOR_TYPE"
                help="Comma separated string of column names where the corresponding values in the metadata will be used for the MSP spectra name"/>
        <param name="xcms_groupids" type="text" label="XCMS peak group ids" value=""
        help="Comma separated string of XCMS group ids to export MSP spectra for. If blank all XCMS peak groups will be used"/>
  
    </inputs>
    <outputs>
        <data name="output" format="txt" label="log" />
        <data name="msp_out" format="msp" from_work_dir="outfile.msp" label="${purity.name} MSP file"/>
    </outputs>
    <tests>
        <test>
            <param name="mode" value="all"/>
            <param name="purity" value="lightpurity.RData"/>
            <output name="msp_out" file="input.msp"/>
        </test>
      
    </tests>
	<help><![CDATA[
------------------------------
Create MSP Files from msPurity
------------------------------

* TO-DO: Averaging functionality
* TO-DO: Add citation for MSP
* TO-DO: Add PRECURSORTYPE if adducts available
* TO-DO: Create MSP from xcms/mzml files

Description
-----------

| This tool will extract the MSMS spectra data from an msPurity-frag4feature object into a file with MSP data format.
| Linking each precursor with its corresponding fragmentation spectra and associating the index within the msPurity object as the name UID.
| Currently, there are three different methods for extracting the data in case that more than one MSMS scan was acquired for the same precursor m/z. See Parameters.

Parameters
----------

**\1. msPurity frag4feature dataset** 

Result object from msPurity purityA-frag4feature functions.

**\2. Spectra use mode (if precursor was fragmented in >1 scans)**

* "Max Intensity" will only use the scan where the precursor m/z signal was maximal.

* "Weighted Average" will merge all the scans, group fragment m/z using a PPM deviation (see 3.) and weight the intensities based on the precursor intensity of that scan. 

* "All" will generate a single entry in the MSP file for each MSMS scan independently.  

**\3. PPM deviation for fragmentation spectra averaging**

Set the value only if you selected "Weighted Average" above, the PPM value is used to define the limits for m/z grouping into a single fragment. 
The weighting is based on the precursor intensity, meaning that the more intense the precursor signal was, the more intensity will its fragments contribute to the averaged spectra.

		
Developers and contributors
---------------------------

- **Jordi Capellades (j.capellades.to@gmail.com) - Universitat Rovira i Virgili (SP)**
- **Ralf Weber (r.j.weber@bham.ac.uk) - University of Birmingham (UK)**

	]]></help>

<expand macro="citations" >
       <citation type="doi">10.1186/s13321-016-0115-9</citation>
</expand>
  
</tool>
